# mail2line-gas

Google Group → LINE通知システム

## 概要

Google Groupに届いたメール（特定のGmailラベル付き）を、Google Apps Script（GAS）で定期的にチェックし、LINE Messaging APIで通知するシステムです。

## 主な機能

- Gmail未読メール検索（ラベル: `Garmin-LiveTrack`）
- メール情報取得（差出人、日付、件名、本文）
- 本文を500文字に制限
- LINE Messaging APIでブロードキャスト通知
- 送信後のメールを自動既読処理
- エラーハンドリング（try-catch、ログ記録）

## ファイル構成

```
mail2line-gas/
├── src/
│   ├── Code.gs          # メインロジック
│   └── Config.gs        # 設定管理
└── README.md            # このファイル
```

## 前提条件

- Googleアカウント（Google Groupメンバーアカウント）
- LINE Messaging APIチャネル
- Gmail（対象ラベルの設定）

## セットアップ手順

### 1. LINE Messaging API設定

1. [LINE Developers](https://developers.line.biz/) にログイン
2. プロバイダーを作成（または既存を選択）
3. 「Messaging API」チャネルを新規作成
4. チャネル設定画面で以下を確認：
   - **チャネルアクセストークン（長期）** を発行・コピー
   - Webhook設定は「無効」でOK（GASからのPushのみ）
5. LINE公式アカウントを友だち追加

### 2. GASプロジェクト作成

1. Google Groupメンバーアカウントでログイン
2. [Google Apps Script](https://script.google.com/) にアクセス
3. 「新しいプロジェクト」を作成
4. プロジェクト名を「mail2line-gas」に変更
5. `Code.gs` と `Config.gs` の2つのファイルを作成
6. このリポジトリの `src/Code.gs` と `src/Config.gs` の内容をコピー&ペースト

### 3. スクリプトプロパティ設定

1. GASエディタで「プロジェクトの設定」（⚙️歯車アイコン）を開く
2. 「スクリプトプロパティ」セクションで「プロパティを追加」をクリック
3. 以下のプロパティを追加：

| キー | 値 | 必須 |
|------|------|------|
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE Messaging APIのチャネルアクセストークン | ✅ 必須 |
| `LINE_GROUP_IDS` | `["C123...", "C456..."]` | オプション（Webhook経由で自動設定。未設定時はbroadcast） |
| `GMAIL_LABEL` | `Garmin-LiveTrack` | オプション（デフォルト: `Garmin-LiveTrack`） |
| `MAX_BODY_LENGTH` | `500` | オプション（デフォルト: `500`） |

### 4. Gmailラベル設定

1. Gmailで「設定」→「フィルタとブロック中のアドレス」を開く
2. 新しいフィルタを作成
   - **To:** Google Groupのメールアドレス（例: `yourgroup@googlegroups.com`）
   - **ラベル:** `Garmin-LiveTrack` を新規作成・選択
3. フィルタを保存

### 5. トリガー設定

1. GASエディタで「トリガー」（⏰時計アイコン）を開く
2. 「トリガーを追加」をクリック
3. 以下のように設定：
   - **実行する関数:** `main`
   - **イベントのソース:** `時間主導型`
   - **時間ベースのトリガー:** `分ベースのタイマー`
   - **時間の間隔:** `10分おき`
4. 「保存」をクリック

### 6. 初回実行・権限付与

1. GASエディタで `main` 関数を選択
2. 「実行」ボタンをクリック
3. 権限の確認画面で「権限を確認」→ アカウント選択 → 「許可」
4. 実行ログを確認（「実行数」から確認可能）

### 7. グループチャットへの通知設定（オプション）

LINEグループに通知を送信する場合は、以下の手順で設定します。

---

## グループチャット設定手順

### Step 1: GAS側の設定（ウェブアプリのデプロイ）

#### 1-1. GASをウェブアプリとして公開

1. GASエディタで「デプロイ」→「新しいデプロイ」をクリック
2. 「種類の選択」（歯車アイコン）→「ウェブアプリ」を選択
3. デプロイ設定:
   - **説明:** `Webhook受信用` （任意の説明）
   - **ウェブアプリ:**
     - **次のユーザーとして実行:** 自分のアカウント（`your-email@gmail.com`）
     - **アクセスできるユーザー:** **`全員`** ← 重要！
4. 「デプロイ」ボタンをクリック
5. 承認画面が表示された場合:
   - 「アクセスを承認」をクリック
   - アカウントを選択
   - 「Advanced（詳細設定）」→「Go to [プロジェクト名] (unsafe)」をクリック
   - 「Allow（許可）」をクリック
6. **ウェブアプリのURL** をコピー
   - 例: `https://script.google.com/macros/s/AKfycby.../exec`
   - このURLを後でLINE Developersで使用します

**確認ポイント:**
- [ ] 「アクセスできるユーザー」が **「全員」** になっている
- [ ] URLの末尾が `/exec` で終わっている
- [ ] URLをコピーした

---

### Step 2: LINE側の設定（Webhook URL設定）

#### 2-1. LINE Developersコンソールを開く

1. [LINE Developers](https://developers.line.biz/) にアクセス
2. ログイン（LINEアカウントでログイン）
3. 該当プロバイダーを選択
4. Messaging APIチャネルを選択

#### 2-2. Webhook設定を有効化

1. **「Messaging API設定」タブ** をクリック
2. **「Webhook設定」セクション** まで下にスクロール
3. 以下の設定を行う:

   **a) Webhook URL の設定:**
   - 「編集」ボタンをクリック
   - Step 1-1でコピーしたGASのウェブアプリURLを貼り付け
     - 例: `https://script.google.com/macros/s/AKfycby.../exec`
   - 「更新」をクリック

   **b) Webhookの利用を有効化:**
   - 「Webhookの利用」トグルを **「オン」** に切り替え

   **c) 接続確認（推奨）:**
   - 「検証」ボタンをクリック
   - 「成功」と表示されればOK
   - エラーが出る場合は、GASのURLが正しいか確認

4. **「応答メッセージ」の設定（重要）:**
   - 同じページの上部にある「応答メッセージ」セクションを確認
   - 「応答メッセージ」を **「オフ」** に設定（Webhookで処理するため）

**確認ポイント:**
- [ ] Webhook URL が設定されている
- [ ] Webhookの利用が「オン」になっている
- [ ] 検証が成功している
- [ ] 応答メッセージが「オフ」になっている

---

### Step 3: LINEグループでの操作

#### 3-1. ボットをグループに招待

1. 通知を送りたいLINEグループを開く
2. グループメニュー（右上の三本線）→「招待」を選択
3. LINE公式アカウント（ボット）を検索して招待
4. ボットがグループに参加したことを確認

#### 3-2. グループを通知先に登録

グループで以下のメッセージを送信:

```
@ボット名 /subscribe
```

**送信方法の詳細:**
1. メッセージ入力欄に「@」を入力
2. ボット名の候補が表示されるので、ボットを選択（メンションが付く）
3. 半角スペースを入力
4. `/subscribe` を入力
5. 送信

**成功した場合:**
ボットから以下のメッセージが返信されます:
```
✅ このグループが通知先として登録されました！
Garmin LiveTrackの通知をこのグループに送信します。
```

**失敗した場合:**
- ボットから返信がない → Webhook設定を確認
- エラーメッセージが返る → GASの実行ログを確認

#### 3-3. 複数グループへの登録（オプション）

複数のグループに通知を送りたい場合:
- 各グループでStep 3-1とStep 3-2を繰り返す
- 全てのグループに一斉に通知が送られるようになります

#### 3-4. グループの登録解除（必要な場合のみ）

通知が不要になったグループでは、以下のコマンドで解除できます:

```
@ボット名 /unsubscribe
```

ボットから以下のメッセージが返信されます:
```
🔕 このグループの通知登録を解除しました。
再度通知を受け取る場合は /subscribe を送信してください。
```

---

### 利用可能なコマンド一覧

| コマンド | 機能 | 実行場所 |
|---------|------|---------|
| `@ボット名 /subscribe` | そのグループを通知先として登録 | グループ内 |
| `@ボット名 /unsubscribe` | そのグループの通知登録を解除 | グループ内 |

**注意事項:**
- コマンドは必ず **グループ内** で送信してください
- 必ず **「@ボット名」でメンション** を付けてください
- Webhook設定が **有効** になっている必要があります
- 複数のグループで `/subscribe` を実行すれば、全グループに一斉送信されます

---

### 設定完了後の動作

1. Gmail に Garmin LiveTrack のメールが届く
2. GASが10分おきに自動実行
3. 登録された **全てのLINEグループ** に通知が送信される
4. メールが自動的に既読になる

---

## テスト方法

### 基本テスト

1. Google Groupアドレスにテストメールを送信
2. Gmailで受信確認（ラベル `Garmin-LiveTrack` が自動付与されるか）
3. GASで `main()` 関数を手動実行
4. LINEに通知が届くか確認
5. Gmailでメールが既読になっているか確認

### エラーケーステスト

- `LINE_CHANNEL_ACCESS_TOKEN` を無効な値に変更 → エラーログ確認
- 存在しないラベルを設定 → 0件処理を確認
- 本文が500文字超のメールを送信 → 省略表示を確認
- 添付ファイル付きメール送信 → 添付ファイル数表示を確認

## カスタマイズ

スクリプトプロパティで以下をカスタマイズ可能：

- **送信先の変更**:
  - **グループチャット**: グループで `@ボット名 /subscribe` コマンドを送信
  - **複数グループ**: 各グループで `/subscribe` を実行すれば全グループに一斉送信
  - **登録解除**: `@ボット名 /unsubscribe` で解除
  - **未設定**: 友だち全員にbroadcast（従来の動作）
- **監視ラベルの変更**: `GMAIL_LABEL` を変更（例: `Garmin-LiveTrack` → `重要メール`）
- **本文表示文字数**: `MAX_BODY_LENGTH` を変更（例: `500` → `1000`）

## 制限事項

### LINE Messaging API制限

- 無料プラン: 月200通（Broadcast）まで
- Broadcastは友だち全員に送信（1回のメール通知 = 1通のカウント）
- メール数が多い場合は有料プランへの移行を検討

### GAS実行制限

- 1日あたりのトリガー実行時間: 90分まで（Googleアカウント）
- 1回の実行時間: 6分まで

### 既読処理

- スレッド全体を既読にする
- 個別メッセージの既読制御は不可

## セキュリティ

- **機密情報（トークン等）は必ずスクリプトプロパティで管理**
- コードに直接記述しない
- GitHubなどに公開する際は、スクリプトプロパティの値は含まれないので安全

## トラブルシューティング

### LINE通知が届かない

1. スクリプトプロパティの `LINE_CHANNEL_ACCESS_TOKEN` が正しいか確認
2. LINE公式アカウントを友だち追加しているか確認
3. 実行ログでエラーメッセージを確認

### `/subscribe` コマンドが反応しない

1. **メンション確認**
   - 必ず「@ボット名」でメンションを付けているか
   - 例: `@ボット名 /subscribe` ✅  `/subscribe` ❌
2. **Webhook設定確認**
   - LINE Developers で Webhook が「有効」になっているか
   - Webhook URL が正しく設定されているか
3. **ウェブアプリのデプロイ確認**
   - 「アクセスできるユーザー」が「全員」になっているか
4. **実行ログを確認**
   - GASエディタで「実行数」→最新のWebhook実行を確認
   - エラーメッセージがあれば内容を確認

### グループチャットに通知が届かない

1. **グループIDが登録されているか確認**
   - スクリプトプロパティで `LINE_GROUP_IDS` の値を確認
   - 空配列 `[]` の場合は `/subscribe` コマンドを送信
2. **ボットがグループに追加されているか確認**
   - グループメンバー一覧にボットが表示されるか
   - ボットが削除されている場合は再招待して `/subscribe` を再送信
3. **実行ログでエラーメッセージを確認**
   - `400 Bad Request`: グループIDが無効
   - `403 Forbidden`: ボットがグループから削除されている

### Webhookが動作しない

1. **ウェブアプリのデプロイ確認**
   - 「アクセスできるユーザー」が「全員」になっているか
2. **Webhook URLが正しいか確認**
   - LINE Developers で設定したURLが正しいか
   - URLの末尾が `/exec` で終わっているか
3. **Webhook検証の実行**
   - LINE Developers で「検証」ボタンをクリック
   - エラーが出る場合はGASの実行ログを確認

### メールが取得できない

1. Gmailラベルが正しく設定されているか確認
2. 対象メールが未読状態か確認
3. スクリプトプロパティの `GMAIL_LABEL` が正しいか確認

### 権限エラー

1. 初回実行時に権限を付与したか確認
2. GASエディタで再度 `main` 関数を手動実行し、権限を再付与

## ライセンス

MIT License

## 作成者

ktaroabobon
