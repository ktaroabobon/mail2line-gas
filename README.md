# mail2line-gas

Google Group → LINE通知システム

## 概要

Google Groupに届いたメール（特定のGmailラベル付き）を、Google Apps Script（GAS）で定期的にチェックし、LINE Messaging APIで通知するシステムです。

## 主な機能

- Gmail未読メール検索（ラベル: `Garmin-LiveTrack`）
- メール情報取得（差出人、日付、件名、本文）
- 本文を500文字に制限
- LINE Messaging APIでブロードキャスト通知
- 送信後のメールを自動既読処理
- エラーハンドリング（try-catch、ログ記録）

## ファイル構成

```
mail2line-gas/
├── src/
│   ├── Code.gs          # メインロジック
│   └── Config.gs        # 設定管理
└── README.md            # このファイル
```

## 前提条件

- Googleアカウント（Google Groupメンバーアカウント）
- LINE Messaging APIチャネル
- Gmail（対象ラベルの設定）

## セットアップ手順

### 1. LINE Messaging API設定

1. [LINE Developers](https://developers.line.biz/) にログイン
2. プロバイダーを作成（または既存を選択）
3. 「Messaging API」チャネルを新規作成
4. チャネル設定画面で以下を確認：
   - **チャネルアクセストークン（長期）** を発行・コピー
   - Webhook設定は「無効」でOK（GASからのPushのみ）
5. LINE公式アカウントを友だち追加

### 2. GASプロジェクト作成

1. Google Groupメンバーアカウントでログイン
2. [Google Apps Script](https://script.google.com/) にアクセス
3. 「新しいプロジェクト」を作成
4. プロジェクト名を「mail2line-gas」に変更
5. `Code.gs` と `Config.gs` の2つのファイルを作成
6. このリポジトリの `src/Code.gs` と `src/Config.gs` の内容をコピー&ペースト

### 3. スクリプトプロパティ設定

1. GASエディタで「プロジェクトの設定」（⚙️歯車アイコン）を開く
2. 「スクリプトプロパティ」セクションで「プロパティを追加」をクリック
3. 以下のプロパティを追加：

| キー | 値 | 必須 |
|------|------|------|
| `LINE_CHANNEL_ACCESS_TOKEN` | LINE Messaging APIのチャネルアクセストークン | ✅ 必須 |
| `GMAIL_LABEL` | `Garmin-LiveTrack` | オプション（デフォルト: `Garmin-LiveTrack`） |
| `MAX_BODY_LENGTH` | `500` | オプション（デフォルト: `500`） |

### 4. Gmailラベル設定

1. Gmailで「設定」→「フィルタとブロック中のアドレス」を開く
2. 新しいフィルタを作成
   - **To:** Google Groupのメールアドレス（例: `yourgroup@googlegroups.com`）
   - **ラベル:** `Garmin-LiveTrack` を新規作成・選択
3. フィルタを保存

### 5. トリガー設定

1. GASエディタで「トリガー」（⏰時計アイコン）を開く
2. 「トリガーを追加」をクリック
3. 以下のように設定：
   - **実行する関数:** `main`
   - **イベントのソース:** `時間主導型`
   - **時間ベースのトリガー:** `分ベースのタイマー`
   - **時間の間隔:** `10分おき`
4. 「保存」をクリック

### 6. 初回実行・権限付与

1. GASエディタで `main` 関数を選択
2. 「実行」ボタンをクリック
3. 権限の確認画面で「権限を確認」→ アカウント選択 → 「許可」
4. 実行ログを確認（「実行数」から確認可能）

## テスト方法

### 基本テスト

1. Google Groupアドレスにテストメールを送信
2. Gmailで受信確認（ラベル `Garmin-LiveTrack` が自動付与されるか）
3. GASで `main()` 関数を手動実行
4. LINEに通知が届くか確認
5. Gmailでメールが既読になっているか確認

### エラーケーステスト

- `LINE_CHANNEL_ACCESS_TOKEN` を無効な値に変更 → エラーログ確認
- 存在しないラベルを設定 → 0件処理を確認
- 本文が500文字超のメールを送信 → 省略表示を確認
- 添付ファイル付きメール送信 → 添付ファイル数表示を確認

## カスタマイズ

スクリプトプロパティで以下をカスタマイズ可能：

- **監視ラベルの変更**: `GMAIL_LABEL` を変更（例: `Garmin-LiveTrack` → `重要メール`）
- **本文表示文字数**: `MAX_BODY_LENGTH` を変更（例: `500` → `1000`）

## 制限事項

### LINE Messaging API制限

- 無料プラン: 月200通（Broadcast）まで
- Broadcastは友だち全員に送信（1回のメール通知 = 1通のカウント）
- メール数が多い場合は有料プランへの移行を検討

### GAS実行制限

- 1日あたりのトリガー実行時間: 90分まで（Googleアカウント）
- 1回の実行時間: 6分まで

### 既読処理

- スレッド全体を既読にする
- 個別メッセージの既読制御は不可

## セキュリティ

- **機密情報（トークン等）は必ずスクリプトプロパティで管理**
- コードに直接記述しない
- GitHubなどに公開する際は、スクリプトプロパティの値は含まれないので安全

## トラブルシューティング

### LINE通知が届かない

1. スクリプトプロパティの `LINE_CHANNEL_ACCESS_TOKEN` が正しいか確認
2. LINE公式アカウントを友だち追加しているか確認
3. 実行ログでエラーメッセージを確認

### メールが取得できない

1. Gmailラベルが正しく設定されているか確認
2. 対象メールが未読状態か確認
3. スクリプトプロパティの `GMAIL_LABEL` が正しいか確認

### 権限エラー

1. 初回実行時に権限を付与したか確認
2. GASエディタで再度 `main` 関数を手動実行し、権限を再付与

## ライセンス

MIT License

## 作成者

ktaroabobon
